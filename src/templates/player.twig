{% set playlistUrl = playlistUrl ?? (asset.hlsPlaylistUrl ?? null) %}
{% set videoId = id ?? ('hls-video-' ~ random()) %}
{% set autoplay = autoplay ?? false %}
{% set muted = muted ?? false %}
{% set loop = loop ?? false %}
{% set playsinline = playsinline ?? false %}
{% set poster = poster ?? null %}
{% set classname = classname ?? '' %}
{% set disablepictureinpicture = disablepictureinpicture ?? false %}

<video
  id="{{ videoId }}"
  controls
  {% if autoplay %}autoplay{% endif %}
  {% if muted %}muted{% endif %}
  {% if loop %}loop{% endif %}
  {% if playsinline %}playsinline{% endif %}
  {% if poster is not null %}
    poster="{{ poster is instance of('craft\\elements\\Asset') ? poster.getUrl() : poster }}"
  {% endif %}
  {% if disablepictureinpicture %}disablepictureinpicture{% endif %}
  class="{{ classname }}"
>
  {% if playlistUrl %}
    <source src="{{ playlistUrl }}" type="application/vnd.apple.mpegurl">
  {% else %}
    <source src="{{ asset.url }}" type="{{ asset.mimeType }}">
  {% endif %} 
  Your browser does not support the video tag.
</video>
{% if playlistUrl %}
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
{% endif %} 
<script>
  {% if playlistUrl %}
    document.addEventListener('DOMContentLoaded', function() {
      var video = document.getElementById('{{ videoId }}');
      if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = "{{ playlistUrl }}";
      } else if (window.Hls && Hls.isSupported()) {
        var hls = new Hls();
        hls.loadSource("{{ playlistUrl }}");
        hls.attachMedia(video);
      } else {
        console.error('HLS is not supported in this browser');
      }
    });
  {% else %}
    console.warn('No playlist URL for video {{ asset.url }}. Possibly the video has finished rendering yet.')
  {% endif %} 
</script>
